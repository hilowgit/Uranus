<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة جمعية أورانوس - لوحة تحكم المشرفين</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%2314B8A6'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' font-size='65' dy='.1em' fill='white' font-family='sans-serif'>U</text></svg>">

    <style>
        :root {
            /* New Dark/Teal Color Palette */
            --bg-primary: #111827;       /* Very Dark Blue/Gray */
            --bg-secondary: #1F2937;    /* Dark Blue/Gray */
            --bg-tertiary: #374151;      /* Lighter Gray for elements */
            --border-color: #4B5563;    /* Subtle Border Color */
            --text-primary: #F9FAFB;      /* Off-white for main text */
            --text-secondary: #D1D5DB;  /* Gray for muted text */
            --accent-primary: #14B8A6;    /* Vibrant Teal */
            --accent-primary-hover: #0D9488; /* Darker Teal for hover */
            --danger-color: #F43F5E;       /* A modern pink/red */
            --danger-hover: #E11D48;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        #auth-container { display: none; width: 100%;}
        .auth-form-container { 
            max-width: 450px; 
            margin: 5rem auto; 
            background-color: var(--bg-secondary);
            padding: 2.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        .auth-form-container .form-control {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .auth-form-container .form-control:focus {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 0.25rem rgba(20, 184, 166, 0.25);
        }
        .auth-form-container .form-floating>label {
            color: var(--text-secondary);
        }

        /* --- New Layout: Sidebar + Main Content --- */
        #app-wrapper {
            display: none; /* Hidden by default, shown by JS */
            flex-grow: 1;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background-color: var(--bg-secondary);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-left: 1px solid var(--border-color);
        }
        .sidebar-header {
            padding: 0 0.5rem 1.5rem 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-header h1 {
            color: var(--text-primary);
            font-size: 1.5rem;
        }
        .sidebar-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: 0.5rem;
        }
        .sidebar-link i {
            margin-left: 0.8rem;
            font-size: 1.1rem;
            width: 20px;
        }
        .sidebar-link:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .sidebar-link.active {
            background-color: var(--accent-primary);
            color: #fff;
            font-weight: 500;
        }
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            overflow-y: auto;
        }
        
        /* Hide all content sections by default */
        .content-section { display: none; }
        .content-section.active { display: block; }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* --- Bootstrap & Component Overrides --- */
        .btn-primary {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--accent-primary-hover);
            border-color: var(--accent-primary-hover);
            color: #fff;
        }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); border-color: var(--danger-hover); }

        .btn-outline-danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .btn-outline-danger:hover {
            color: #fff;
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .form-control, .form-select {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 0.25rem rgba(20, 184, 166, 0.25);
        }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-check-input:checked {
             background-color: var(--accent-primary);
             border-color: var(--accent-primary);
        }
        .input-group-text {
            background-color: var(--bg-tertiary);
            border-color: var(--border-color);
        }
        
        /* Redesigned Result Cards */
        .result-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--card-shadow);
        }
        .result-card.completed {
            background-color: #1f2937a1;
            opacity: 0.7;
        }
        .result-card h5 { color: var(--text-primary); }
        .result-card p { color: var(--text-secondary); }
        .result-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
        }
        .card-actions {
            position: absolute;
            top: 1rem;
            left: 1rem;
        }
        .card-actions .btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
        }

        /* Redesigned Modals */
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
        }
        .modal-header {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title { color: var(--text-primary); }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .form-section-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }
        .search-results-dropdown {
            position: absolute; background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 0.5rem; max-height: 200px; overflow-y: auto;
            width: 100%; z-index: 1060;
        }
        .search-results-dropdown .list-group-item {
            background-color: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }
        .search-results-dropdown .list-group-item:hover { background-color: var(--bg-primary); }
        .selected-tag {
            display: inline-flex; align-items: center; background-color: var(--bg-tertiary);
            color: var(--accent-primary); padding: 0.35rem 0.75rem; border-radius: 1rem;
            font-weight: 500; margin: 0.25rem;
        }
        .selected-tag button {
            background: none; border: none; font-size: 1.2rem;
            margin-right: 0.5rem; color: var(--accent-primary);
        }

        /* Redesigned Calendar */
        #calendar-container {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
        }
        #calendar-header h3 { color: var(--text-primary); }
        #calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
        }
        .calendar-day-header {
            text-align: center; padding: 0.5rem; font-weight: 500; color: var(--text-secondary);
        }
        .calendar-day {
            border: 1px solid var(--border-color); border-radius: 8px;
            min-height: 110px; display: flex; flex-direction: column;
            padding: 0.5rem; cursor: pointer; transition: background-color 0.2s;
        }
        .calendar-day:hover { background-color: var(--bg-tertiary); }
        .calendar-day.not-in-month { background-color: var(--bg-primary); cursor: default; }
        .calendar-day.today .day-number {
            background-color: var(--accent-primary); color: white; border-radius: 50%;
            width: 30px; height: 30px; display: inline-flex;
            align-items: center; justify-content: center; font-weight: bold;
        }
        .event-dot {
            width: 100%; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem;
            color: white; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .event-dot.course { background-color: #4f46e5; }
        .event-dot.appointment { background-color: var(--accent-primary-hover); }

        /* Redesigned Inventory Table */
        .inventory-table {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .inventory-table th, .inventory-table td {
            vertical-align: middle; text-align: center; padding: 1rem;
            border-color: var(--border-color);
        }
        .inventory-table thead th {
            background-color: var(--bg-primary); color: var(--text-primary);
            font-weight: 600;
        }
        .inventory-table .item-name-cell { text-align: right; font-weight: bold; color: var(--text-primary); }
        .inventory-table .actions-cell { width: 180px; }
        .inventory-table tbody tr:hover { background-color: var(--bg-tertiary); }
        .balance-ok { color: var(--success-color); }
        .balance-low { color: var(--warning-color); }
        .balance-danger { color: var(--danger-color); }

        /* Summary Panel Cards */
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 2rem;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        .summary-card .icon {
            font-size: 2.5rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
        }
        .summary-card h5 {
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .loader { text-align: center; padding: 2rem; }
        .d-none { display: none !important; }
        .clickable { cursor: pointer; }
    </style>
</head>
<body>
    
    <div id="auth-container" class="container">
        <div class="auth-form-container">
            <div class="text-center mb-4">
                <h1 class="h3 mb-3 fw-normal">تسجيل الدخول</h1>
                <p class="text-secondary">لوحة تحكم جمعية أورانوس</p>
            </div>
            <form id="login-form">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="login-email" placeholder="name@example.com" required>
                    <label for="login-email">البريد الإلكتروني</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="login-password" placeholder="Password" required>
                    <label for="login-password">كلمة السر</label>
                </div>
                <button class="w-100 btn btn-lg btn-primary" type="submit">تسجيل الدخول</button>
                <div id="auth-error" class="alert alert-danger mt-3 d-none"></div>
            </form>
        </div>
    </div>

    <div id="app-wrapper">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="fw-bold m-0">جمعية أورانوس</h1>
                <p class="m-0">لوحة تحكم المشرفين</p>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#summary-panel" class="sidebar-link active"><i class="fas fa-chart-pie"></i><span>الملخصات</span></a></li>
                <li><a href="#trainees-panel" class="sidebar-link"><i class="fas fa-user-graduate"></i><span>المتدربين</span></a></li>
                <li><a href="#trainers-panel" class="sidebar-link"><i class="fas fa-chalkboard-teacher"></i><span>المدربين</span></a></li>
                <li><a href="#schedule-panel" class="sidebar-link"><i class="fas fa-calendar-alt"></i><span>الجدولة</span></a></li>
                <li><a href="#calendar-panel" class="sidebar-link"><i class="fas fa-calendar-week"></i><span>التقويم</span></a></li>
                <li><a href="#inventory-panel" class="sidebar-link"><i class="fas fa-boxes-stacked"></i><span>الجرد</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج</button>
            </div>
        </nav>

        <main class="main-content">
            <div id="summary-panel" class="content-section">
                <div class="page-header">
                    <h2><i class="fas fa-chart-pie me-3 text-secondary"></i>الملخصات</h2>
                </div>
                <div id="summary-content"></div>
            </div>

            <div id="trainees-panel" class="content-section">
                <div class="page-header">
                    <h2><i class="fas fa-user-graduate me-3 text-secondary"></i>المتدربين</h2>
                    <button id="addTraineeBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة متدرب</button>
                </div>
                <div class="input-group mb-4">
                    <input type="text" class="form-control" id="trainee-search-input" placeholder="أدخل اسم المتدرب للبحث...">
                    <button class="btn btn-primary" type="button" id="trainee-search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="trainee-results" class="mt-4"></div>
            </div>

            <div id="trainers-panel" class="content-section">
                 <div class="page-header">
                    <h2><i class="fas fa-chalkboard-teacher me-3 text-secondary"></i>المدربين</h2>
                    <button id="addTrainerBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة مدرب</button>
                </div>
                <div class="input-group mb-4">
                    <input type="text" class="form-control" id="trainer-search-input" placeholder="أدخل اسم المدرب للبحث...">
                    <button class="btn btn-primary" type="button" id="trainer-search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="trainer-results" class="mt-4"></div>
            </div>

            <div id="schedule-panel" class="content-section">
                 <div class="page-header">
                    <h2><i class="fas fa-calendar-alt me-3 text-secondary"></i>الجدولة</h2>
                    <button id="addScheduleBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة موعد</button>
                </div>
                <div class="input-group mb-4">
                    <input type="text" class="form-control" id="schedule-search-input" placeholder="أدخل اسم الكورس للبحث...">
                    <button class="btn btn-primary" type="button" id="schedule-search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="schedule-results" class="mt-4"></div>
            </div>
            
            <div id="calendar-panel" class="content-section">
                <div class="page-header">
                     <h2><i class="fas fa-calendar-week me-3 text-secondary"></i>التقويم</h2>
                </div>
                <div id="calendar-container">
                    <div id="calendar-header" class="d-flex justify-content-between align-items-center mb-4">
                        <button id="prev-month-btn" class="btn btn-primary"><i class="fas fa-chevron-right"></i></button>
                        <h3 id="month-year-display" class="m-0"></h3>
                        <button id="next-month-btn" class="btn btn-primary"><i class="fas fa-chevron-left"></i></button>
                    </div>
                    <div id="calendar-grid"></div>
                </div>
            </div>
            
            <div id="inventory-panel" class="content-section">
                <div class="page-header">
                    <h2><i class="fas fa-boxes-stacked me-3 text-secondary"></i>الجرد والمخزون</h2>
                    <div>
                        <button id="addInventoryTransactionBtn" class="btn btn-success me-2"><i class="fas fa-exchange-alt me-2"></i>إضافة حركة</button>
                        <button id="addInventoryItemBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة صنف</button>
                    </div>
                </div>
                <div class="input-group mb-4">
                    <input type="text" class="form-control" id="inventory-search-input" placeholder="أدخل اسم الصنف للبحث...">
                    <button class="btn btn-primary" type="button" id="inventory-search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="inventory-results" class="mt-4 table-responsive"></div>
            </div>

        </main>
    </div>

    <div class="modal fade" id="traineeModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="traineeForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="traineeModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="form-section-title">البيانات الشخصية</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">الأسم الثلاثي</label><input type="text" name="fullname" class="form-control" required></div><div class="col-md-6"><label class="form-label">رقم الهاتف</label><input type="text" name="phone" class="form-control"></div><div class="col-12"><label class="form-label">السكن</label><input type="text" name="address" class="form-control"></div><div class="col-md-6"><label class="form-label">الرقم الوطني</label><input type="text" name="national_id" class="form-control"></div><div class="col-md-6"><label class="form-label">التولد</label><input type="date" name="dob" class="form-control"></div><div class="col-md-6"><label class="form-label">أسم الأم</label><input type="text" name="mother_name" class="form-control"></div><div class="col-md-6"><label class="form-label">التحصيل العلمي</label><input type="text" name="education" class="form-control"></div></div><h6 class="form-section-title">تسجيل الكورسات</h6><div class="position-relative"><label class="form-label">ابحث عن كورس لإضافته</label><input type="text" id="course-search-input" class="form-control" placeholder="...ابدأ بكتابة اسم الكورس"><div id="course-search-results-dropdown" class="search-results-dropdown d-none"></div></div><div id="selected-courses-list" class="mt-2"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary px-4">حفظ</button></div></form></div></div></div>
    <div class="modal fade" id="trainerModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="trainerForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="trainerModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="form-section-title">البيانات الشخصية</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">الأسم الثلاثي</label><input type="text" name="fullname" class="form-control" required></div><div class="col-md-6"><label class="form-label">رقم الهاتف</label><input type="text" name="phone" class="form-control"></div><div class="col-12"><label class="form-label">السكن</label><input type="text" name="address" class="form-control"></div><div class="col-md-4"><label class="form-label">الرقم الوطني</label><input type="text" name="national_id" class="form-control"></div><div class="col-md-4"><label class="form-label">التولد</label><input type="date" name="dob" class="form-control"></div><div class="col-md-4"><label class="form-label">أسم الأم</label><input type="text" name="mother_name" class="form-control"></div><div class="col-md-6"><label class="form-label">التحصيل العلمي</label><input type="text" name="education" class="form-control"></div><div class="col-md-6"><label class="form-label">الاختصاص التدريبي</label><input type="text" name="specialty" class="form-control"></div><div class="col-12"><label class="form-label">رفع السيرة الذاتية (PDF)</label><input type="file" name="cv_file" class="form-control" accept=".pdf"><small id="currentCv" class="form-text text-primary"></small></div></div><h6 class="form-section-title">بيانات التعاقد</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">تاريخ التعاقد</label><input type="date" name="contract_start_date" class="form-control"></div><div class="col-md-6"><label class="form-label">تاريخ انتهاء العقد</label><input type="date" name="contract_end_date" class="form-control"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary px-4">حفظ</button></div></form></div></div></div>
    <div class="modal fade" id="scheduleModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="scheduleForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="scheduleModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <h6 class="form-section-title">بيانات الكورس</h6>
    <div class="row g-3">
        <div class="col-12 position-relative">
            <label class="form-label">اختر الكورس</label>
            <input type="text" id="schedule-course-search-input" class="form-control" placeholder="ابحث عن كورس..." autocomplete="off">
            <div id="schedule-course-search-results" class="search-results-dropdown d-none"></div>
            <div id="selected-schedule-course-display" class="mt-2"></div>
            <input type="hidden" name="course_id" required>
        </div>
        <div class="col-12 position-relative">
            <label class="form-label">اختر المدرب</label>
            <input type="text" id="schedule-trainer-search-input" class="form-control" placeholder="ابحث عن مدرب..." autocomplete="off">
            <div id="schedule-trainer-search-results" class="search-results-dropdown d-none"></div>
            <div id="selected-schedule-trainer-display" class="mt-2"></div>
            <input type="hidden" name="trainer_id" required>
        </div>
        <div class="col-md-6"><label class="form-label">اسم القاعة</label><input type="text" name="hall_name" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">عدد المتدربين</label><input type="number" name="trainee_count" class="form-control"></div>
    </div>
    <h6 class="form-section-title">التوقيت والحالة</h6>
    <div class="row g-3">
        <div class="col-md-6"><label class="form-label">تاريخ البدء</label><input type="date" name="start_date" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">تاريخ الانتهاء</label><input type="date" name="end_date" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">وقت البدء</label><input type="time" name="start_time" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">وقت الانتهاء</label><input type="time" name="end_time" class="form-control"></div>
        <div class="col-12"><label class="form-label">أيام الكورس</label><input type="text" name="course_days" class="form-control" placeholder="الأحد - الثلاثاء - الخميس"></div>
        <div class="col-12 mt-3">
            <div class="form-check form-switch p-0 d-flex align-items-center">
                <input class="form-check-input ms-3 me-1" type="checkbox" role="switch" id="courseStatus" name="status" style="transform: scale(1.3);">
                <label class="form-check-label" for="courseStatus">الكورس منتهي</label>
                <small class="text-muted me-auto">(عند تفعيل هذا الخيار، سيتم قفل جميع التعديلات)</small>
            </div>
        </div>
    </div>
    
    <h6 class="form-section-title">الطلاب المسجلون في الكورس</h6>
    <div class="position-relative mb-2">
        <label for="schedule-trainee-search-input" class="form-label visually-hidden">ابحث عن متدرب لإضافته</label>
        <input type="text" id="schedule-trainee-search-input" class="form-control" placeholder="... ابدأ بكتابة اسم متدرب لإضافته للقائمة">
        <div id="schedule-trainee-search-results" class="search-results-dropdown d-none"></div>
    </div>
    <div id="schedule-selected-trainees-list" class="mt-2 p-2 bg-light rounded" style="min-height: 50px;">
    </div>
    
    <h6 class="form-section-title">تفاصيل إضافية</h6><div class="row g-3"><div class="col-12"><label class="form-label">متقدمون للبورد الألماني (افصل بفاصلة)</label><input type="text" name="german_board_applicants" class="form-control"></div><div class="col-12"><label class="form-label">خطة المسار</label><textarea name="course_plan" class="form-control" rows="3"></textarea></div><div class="col-12"><label class="form-label">المواد المطلوبة</label><textarea name="required_materials" class="form-control" rows="2"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary px-4">حفظ</button></div></form></div></div></div>
    <div class="modal fade" id="attendanceModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="attendanceForm"><input type="hidden" name="schedule_id"><div class="modal-header"><h5 class="modal-title" id="attendanceModalTitle">أخذ التفقد</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label for="attendance_date" class="form-label">تاريخ المحاضرة</label><input type="date" name="attendance_date" id="attendance_date" class="form-control" required></div><hr><div id="attendance-student-list"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary px-4">حفظ التفقد</button></div></form></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">تأكيد الحذف</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="confirmModalText"></p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">حذف</button></div></div></div></div>
    <div class="modal fade" id="appointmentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="appointmentForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="appointmentModalTitle">إضافة/تعديل موعد</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <div id="day-appointments-list" class="mb-3"></div>
        <hr/>
        <h6 class="form-section-title" id="appointment-form-section-title">إضافة موعد جديد</h6>
        <div class="mb-3"><label class="form-label">عنوان الموعد</label><input type="text" name="title" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">تاريخ الموعد</label><input type="date" name="appointment_date" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">الوصف (اختياري)</label><textarea name="description" class="form-control" rows="3"></textarea></div>
    </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ الموعد</button></div></form></div></div></div>
    <div class="modal fade" id="inventoryTransactionModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="inventoryTransactionForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="inventoryTransactionModalTitle">إضافة حركة مخزون</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <div class="mb-3 position-relative">
            <label class="form-label">الصنف</label>
            <input type="text" id="inventory-item-search-input" class="form-control" placeholder="ابحث عن صنف..." autocomplete="off">
            <div id="inventory-item-search-results" class="search-results-dropdown d-none"></div>
            <div id="selected-inventory-item-display" class="mt-2"></div>
            <input type="hidden" name="item_id" required>
        </div>
        <div class="mb-3"><label class="form-label">نوع الحركة</label><select name="transaction_type" class="form-select" required><option value="in">داخل (شراء)</option><option value="out">خارج (صرف)</option></select></div><div class="mb-3"><label class="form-label">الكمية</label><input type="number" name="quantity" class="form-control" required min="1"></div><div class="mb-3"><label class="form-label">التاريخ</label><input type="date" name="transaction_date" class="form-control" required></div><div class="mb-3"><label class="form-label">البيان (اختياري)</label><input type="text" name="description" class="form-control"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ الحركة</button></div></form></div></div></div>
    <div class="modal fade" id="inventoryDetailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="inventoryDetailModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="inventoryDetailModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button></div></div></div></div>
    <div class="modal fade" id="courseDetailModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="courseDetailModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="courseDetailModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // =================================================================================
        // !! تم وضع بيانات الاتصال الخاصة بك هنا !!
        // =================================================================================
        const SUPABASE_URL = 'https://sacorfhclmbubtablzuz.supabase.co';  
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhY29yZmhjbG1idWJ0YWJsenV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4Njk0MjUsImV4cCI6MjA2NjQ0NTQyNX0.OjeACPPo0GJBirnPrfciyhch4XTUUKBBoYFacKRqoh8';
        // =================================================================================
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const authContainer = document.getElementById('auth-container');
        const appWrapper = document.getElementById('app-wrapper'); // Changed from app-container

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const authErrorDiv = document.getElementById('auth-error');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) {
                authErrorDiv.textContent = 'البريد الإلكتروني أو كلمة السر غير صحيحة.';
                authErrorDiv.classList.remove('d-none');
            } else {
                authErrorDiv.classList.add('d-none');
                checkUser();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            checkUser();
        });

        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                authContainer.style.display = 'none';
                appWrapper.style.display = 'flex'; // Use flex for sidebar layout
                initializeApp();
            } else {
                authContainer.style.display = 'flex'; // Use flex to center the form
                appWrapper.style.display = 'none';
            }
        }
        
        // --- NEW: SIDEBAR NAVIGATION LOGIC ---
        function setupSidebarNavigation() {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentSections = document.querySelectorAll('.content-section');

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    const targetId = link.getAttribute('href').substring(1);

                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });

                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        targetSection.classList.add('active');
                    }
                });
            });
            // Show the first section by default
            if (sidebarLinks.length > 0) {
                 document.querySelector('.sidebar-link.active')?.click();
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        const showLoader = (containerId) => {
            document.getElementById(containerId).innerHTML = `<div class="loader"><div class="spinner-border text-primary" role="status"></div></div>`;
        };
        
        let deleteFunction = null;  
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        function confirmDeletion(callback, message) {
            hideAllTooltips();
            document.getElementById('confirmModalText').textContent = message;
            deleteFunction = callback;
            confirmModal.show();
        }
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteFunction) deleteFunction();
            confirmModal.hide();
        });

        const sanitizeData = (data) => {
            for (const key in data) {
                if (data[key] === '') data[key] = null;
            }
            return data;
        };

        function hideAllTooltips() {
            const tooltips = document.querySelectorAll('.tooltip');
            tooltips.forEach(tooltip => {
                tooltip.remove();
            });
        }
        
        // ==========================================================
        //  <<< ALL CORE APP LOGIC (Supabase functions) ARE PRESERVED HERE >>>
        //  The following JavaScript is identical to your original file.
        //  No changes were made to the data handling logic.
        // ==========================================================
        
        // --- CORE APP LOGIC ---
        // Global Caches & State
        let allCoursesCache = [];
        let allTraineesCache = [];
        let allInventoryItemsCache = [];
        let allTrainersCache = [];
        let selectedCourses = new Map();
        let scheduleSelectedTrainees = new Map();
        let calendarDate = new Date();
        let lastOpenedDetail = { itemId: null, itemName: null };
        let transactionModalInstance;
        let detailModalInstance;


        async function fetchTrainers(searchTerm = '') {
            showLoader('trainer-results');
            let query = supabaseClient.from('trainers').select('*').order('fullname');
            if (searchTerm) query = query.ilike('fullname', `%${searchTerm}%`);
            const { data, error } = await query;
            if (error) console.error('Error fetching trainers:', error);
            else displayTrainers(data);
        }

        function displayTrainers(trainers) {
            const container = document.getElementById('trainer-results');
            if (!trainers || trainers.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا يوجد مدربين.</div>`; return;
            }
            // MODIFIED FOR NEW DROPDOWN ACTIONS
            container.innerHTML = trainers.map(trainer => `
                <div class="result-card mb-3">
                    <div class="card-actions dropdown">
                        <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="#" onclick="openTrainerModal(true, '${trainer.id}')">تعديل</a></li>
                            <li><a class="dropdown-item" href="#" onclick="handleDeleteTrainer('${trainer.id}', '${trainer.fullname}')">حذف</a></li>
                        </ul>
                    </div>
                    <h5><i class="fas fa-user-tie me-2 text-secondary"></i>${trainer.fullname}</h5>
                    <p class="mb-1"><i class="fas fa-phone-alt me-2"></i>${trainer.phone || 'N/A'}</p>
                    <p class="mb-1"><i class="fas fa-briefcase me-2"></i>${trainer.specialty || 'N/A'}</p>
                    <p class="mb-0"><i class="fas fa-file-pdf me-2"></i>${trainer.cv_url ? `<a href="${trainer.cv_url}" target="_blank">عرض السيرة الذاتية</a>` : 'لا يوجد'}</p>
                </div>
            `).join('');
        }
        
        const trainerModal = new bootstrap.Modal(document.getElementById('trainerModal'));
        async function openTrainerModal(isEdit = false, id = null) {
            hideAllTooltips();
            const form = document.getElementById('trainerForm');
            form.reset();
            document.getElementById('currentCv').textContent = '';
            form.querySelector('[name="id"]').value = '';
            if (isEdit) {
                document.getElementById('trainerModalTitle').textContent = 'تعديل بيانات المدرب';
                const { data, error } = await supabaseClient.from('trainers').select('*').eq('id', id).single();
                if (error) return;
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && key !== 'cv_file') input.value = data[key];
                });
                if (data.cv_url) document.getElementById('currentCv').textContent = `الملف الحالي: ${data.cv_url.split('/').pop()}`;
            } else {
                document.getElementById('trainerModalTitle').textContent = 'إضافة مدرب جديد';
            }
            trainerModal.show();
        }
        
        async function handleTrainerFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let trainerData = Object.fromEntries(formData.entries());
            const id = trainerData.id;
            const cvFile = trainerData.cv_file;
            delete trainerData.cv_file;
            delete trainerData.id;

            if (cvFile && cvFile.size > 0) {
                const fileExt = cvFile.name.split('.').pop();
                const newFileName = `${Date.now()}.${fileExt}`;
                const filePath = `public/${newFileName}`;
                const { error: uploadError } = await supabaseClient.storage.from('trainer-cvs').upload(filePath, cvFile);
                if (uploadError) {
                    console.error('Upload Error:', uploadError);
                    Swal.fire('خطأ!', 'خطأ في رفع الملف.', 'error');
                    return;  
                }
                const { data: urlData } = supabaseClient.storage.from('trainer-cvs').getPublicUrl(filePath);
                trainerData.cv_url = urlData.publicUrl;
            }

            const sanitizedData = sanitizeData(trainerData);
            let response = id ? await supabaseClient.from('trainers').update(sanitizedData).eq('id', id) : await supabaseClient.from('trainers').insert([sanitizedData]);
            
            if (response.error) {
                console.error('Error saving trainer:', response.error); 
                Swal.fire('خطأ!', 'خطأ في حفظ البيانات.', 'error');
            } else {
                Swal.fire('تم!', 'تم الحفظ بنجاح!', 'success');
                trainerModal.hide(); 
                fetchTrainers();
            }
        }
        
        function handleDeleteTrainer(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('trainers').delete().eq('id', id);
                if (error) Swal.fire('خطأ!', 'خطأ في الحذف.', 'error');
                else { Swal.fire('تم الحذف!', '', 'success'); fetchTrainers(); }
            }, `هل أنت متأكد من حذف المدرب "${name}"؟`);
        }

        async function fetchTrainees(searchTerm = '') {
            showLoader('trainee-results');
            let query = supabaseClient.from('trainees').select(`*, trainee_enrollments(courses(name))`).order('fullname');
            if (searchTerm) query = query.ilike('fullname', `%${searchTerm}%`);
            const { data, error } = await query;
            if (error) console.error('Error fetching trainees:', error);
            else displayTrainees(data);
        }

        function displayTrainees(trainees) {
            const container = document.getElementById('trainee-results');
            if (!trainees || trainees.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا يوجد متدربين.</div>`; return;
            }
            container.innerHTML = trainees.map(trainee => {
                const enrolledCourses = trainee.trainee_enrollments.length > 0 ? trainee.trainee_enrollments.map(e => `<span class="badge" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">${e.courses.name}</span>`).join(' ') : 'لا يوجد';
                return `
                <div class="result-card mb-3">
                    <div class="card-actions dropdown">
                        <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="#" onclick="openTraineeModal(true, '${trainee.id}')">تعديل</a></li>
                            <li><a class="dropdown-item" href="#" onclick="handleDeleteTrainee('${trainee.id}', '${trainee.fullname}')">حذف</a></li>
                        </ul>
                    </div>
                    <h5><i class="fas fa-user-graduate me-2 text-secondary"></i>${trainee.fullname}</h5>
                    <p class="mb-1"><i class="fas fa-phone-alt me-2"></i>${trainee.phone || 'N/A'}</p>
                    <p class="mb-0"><i class="fas fa-book-open me-2"></i><strong>الكورسات:</strong> ${enrolledCourses}</p>
                </div>`;
            }).join('');
        }
        
        const traineeModal = new bootstrap.Modal(document.getElementById('traineeModal'));
        
        async function openTraineeModal(isEdit = false, id = null) {
            hideAllTooltips();
            const form = document.getElementById('traineeForm');
            form.reset();
            form.querySelector('[name="id"]').value = id || '';
            selectedCourses.clear();
            
            if (isEdit) {
                document.getElementById('traineeModalTitle').textContent = 'تعديل بيانات المتدرب';
                const { data: traineeData } = await supabaseClient.from('trainees').select('*, trainee_enrollments(course_id, courses(name))').eq('id', id).single();
                if (!traineeData) return;
                Object.keys(traineeData).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) input.value = traineeData[key];
                });

                traineeData.trainee_enrollments.forEach(enrollment => {
                    selectedCourses.set(enrollment.course_id, enrollment.courses.name);
                });
            } else {
                document.getElementById('traineeModalTitle').textContent = 'إضافة متدرب جديد';
            }
            renderSelectedCourses();
            traineeModal.show();
        }

        function renderCourseSearchResults(searchTerm = '') {
            const resultsContainer = document.getElementById('course-search-results-dropdown');
            if(!searchTerm) {
                resultsContainer.classList.add('d-none');
                return;
            }
            const availableCourses = allCoursesCache.filter(course => !selectedCourses.has(course.id));
            const filtered = availableCourses.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            if(filtered.length > 0) {
                resultsContainer.innerHTML = `<ul class="list-group">${filtered.map(c => `<li class="list-group-item" onclick="selectCourse('${c.id}', '${c.name}')">${c.name}</li>`).join('')}</ul>`;
                resultsContainer.classList.remove('d-none');
            } else {
                resultsContainer.classList.add('d-none');
            }
        }

        function selectCourse(id, name) {
            selectedCourses.set(id, name);
            document.getElementById('course-search-input').value = '';
            document.getElementById('course-search-results-dropdown').classList.add('d-none');
            renderSelectedCourses();
        }

        function removeCourse(id) {
            selectedCourses.delete(id);
            renderSelectedCourses();
        }

        function renderSelectedCourses() {
            const listContainer = document.getElementById('selected-courses-list');
            listContainer.innerHTML = '';
            if (selectedCourses.size > 0) {
                for (const [id, name] of selectedCourses.entries()) {
                    listContainer.innerHTML += `<div class="selected-tag" data-id="${id}">${name}<button type="button" onclick="removeCourse('${id}')">&times;</button></div>`;
                }
            }
        }

        async function handleTraineeFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const traineeData = {};
            
            formData.forEach((value, key) => {
                traineeData[key] = value;
            });

            const id = traineeData.id;
            delete traineeData.id;

            const sanitizedData = sanitizeData(traineeData);
            let response = id ? await supabaseClient.from('trainees').update(sanitizedData).eq('id', id).select().single() : await supabaseClient.from('trainees').insert([sanitizedData]).select().single();
            
            if (response.error) { Swal.fire('خطأ!', 'خطأ في حفظ المتدرب.', 'error'); return; }
            
            const traineeId = response.data.id;
            await supabaseClient.from('trainee_enrollments').delete().eq('trainee_id', traineeId);
            
            if (selectedCourses.size > 0) {
                const enrollmentsToInsert = Array.from(selectedCourses.keys()).map(courseId => ({ trainee_id: traineeId, course_id: courseId }));
                await supabaseClient.from('trainee_enrollments').insert(enrollmentsToInsert);
            }
            
            Swal.fire('تم!', 'تم الحفظ بنجاح!', 'success');
            traineeModal.hide(); 
            fetchTrainees(); 
            fetchSummaryData();
        }
        
        function handleDeleteTrainee(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('trainees').delete().eq('id', id);
                if (error) Swal.fire('خطأ!', 'خطأ في الحذف.', 'error');
                else { Swal.fire('تم الحذف!', '', 'success'); fetchTrainees(); fetchSummaryData(); }
            }, `هل أنت متأكد من حذف "${name}"؟`);
        }
        
        async function fetchSchedules(searchTerm = '') {
            showLoader('schedule-results');
            let query = supabaseClient.from('schedules').select(`*, courses!inner(name), trainers(fullname)`)
                .order('status', { ascending: true, nullsFirst: false }) 
                .order('start_date', { ascending: false });

            if (searchTerm) {
                query = query.ilike('courses.name', `%${searchTerm}%`);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Error fetching schedules:', error);
                document.getElementById('schedule-results').innerHTML = `<div class="alert alert-danger">حدث خطأ أثناء جلب المواعيد.</div>`;
            } else {
                displaySchedules(data);
            }
        }
        
        function displaySchedules(schedules) {
            const container = document.getElementById('schedule-results');
            if (!schedules || schedules.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا توجد مواعيد مجدولة تطابق البحث.</div>`;
                return;
            }
            container.innerHTML = schedules.map(schedule => {
                const isCompleted = schedule.status === 'completed';
                const statusBadge = isCompleted 
                    ? `<span class="badge bg-secondary status-badge">منتهي</span>`
                    : `<span class="badge bg-success status-badge">نشط</span>`;

                return `
                <div class="result-card mb-3 ${isCompleted ? 'completed' : ''}">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="m-0"><i class="fas fa-calendar-check me-2 text-secondary"></i>${schedule.courses ? schedule.courses.name : 'N/A'}</h5>
                                ${statusBadge}
                            </div>
                            <p class="mb-1 small"><i class="fas fa-chalkboard-teacher me-2"></i>${schedule.trainers ? schedule.trainers.fullname : 'N/A'}</p>
                            <p class="mb-1 small"><i class="fas fa-map-marker-alt me-2"></i>${schedule.hall_name || 'N/A'}</p>
                            <p class="mb-0 small"><i class="far fa-clock me-2"></i>${schedule.start_date || '?'} - ${schedule.end_date || '?'}</p>
                        </div>
                        <div class="card-actions dropdown">
                             <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                             <ul class="dropdown-menu dropdown-menu-dark">
                                <li><a class="dropdown-item" href="#" onclick="openAttendanceModal('${schedule.id}', '${schedule.courses.name}')">أخذ التفقد</a></li>
                                <li><a class="dropdown-item" href="#" onclick="openScheduleModal(true, '${schedule.id}')">تعديل</a></li>
                                <li><a class="dropdown-item" href="#" onclick="handleDeleteSchedule('${schedule.id}', '${schedule.courses ? schedule.courses.name : ''}')">حذف</a></li>
                             </ul>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        
        function toggleScheduleFormLock(isLocked) {
            const form = document.getElementById('scheduleForm');
            const elementsToLock = form.querySelectorAll('.modal-body input:not(#courseStatus), .modal-body select, .modal-body textarea, .modal-body .selected-tag button');

            elementsToLock.forEach(el => {
                el.disabled = isLocked;
            });
            
            const traineeSearchInput = document.getElementById('schedule-trainee-search-input');
            if (traineeSearchInput) {
                traineeSearchInput.disabled = isLocked;
            }
        }

        async function openScheduleModal(isEdit = false, id = null) {
            hideAllTooltips();
            const form = document.getElementById('scheduleForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            
            // Clear search/select fields
            document.getElementById('selected-schedule-course-display').innerHTML = '';
            document.getElementById('selected-schedule-trainer-display').innerHTML = '';
            document.getElementById('schedule-course-search-input').value = '';
            document.getElementById('schedule-trainer-search-input').value = '';
            
            scheduleSelectedTrainees.clear();
            document.getElementById('schedule-trainee-search-input').value = '';

            if (isEdit) {
                document.getElementById('scheduleModalTitle').textContent = 'تعديل الموعد';
                const { data: scheduleData, error: scheduleError } = await supabaseClient.from('schedules').select('*, courses(name), trainers(fullname)').eq('id', id).single();
                if (scheduleError || !scheduleData) { console.error("Error fetching schedule for edit", scheduleError); return; }
                
                Object.keys(scheduleData).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (key === 'status') {
                            input.checked = (scheduleData[key] === 'completed');
                        } else if(key === 'german_board_applicants' && Array.isArray(scheduleData[key])) {
                            input.value = scheduleData[key].join(', ');
                        } else {
                            input.value = scheduleData[key];
                        }
                    }
                });

                // Set selected course and trainer
                if (scheduleData.courses) {
                    selectCourseForSchedule(scheduleData.course_id, scheduleData.courses.name);
                }
                if (scheduleData.trainers) {
                    selectTrainerForSchedule(scheduleData.trainer_id, scheduleData.trainers.fullname);
                }

                if (scheduleData.course_id) {
                    const { data: enrollments, error: enrollError } = await supabaseClient.from('trainee_enrollments').select('trainees(id, fullname)').eq('course_id', scheduleData.course_id);
                    if (enrollError) console.error("Error fetching enrollments", enrollError);
                    else if (enrollments) {
                        enrollments.forEach(e => {
                            if(e.trainees) scheduleSelectedTrainees.set(e.trainees.id, e.trainees.fullname);
                        });
                    }
                }
                toggleScheduleFormLock(scheduleData.status === 'completed');
            } else {
                document.getElementById('scheduleModalTitle').textContent = 'إضافة موعد جديد';
                toggleScheduleFormLock(false); // Unlock for new entries
            }
            
            renderScheduleSelectedTrainees();
            scheduleModal.show();
        }

        async function handleScheduleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let scheduleData = Object.fromEntries(formData.entries());
            const id = scheduleData.id;
            delete scheduleData.id;
            
            if (!scheduleData.course_id || !scheduleData.trainer_id) {
                Swal.fire('تنبيه!', 'الرجاء اختيار كورس ومدرب.', 'warning');
                return;
            }

            scheduleData.status = form.querySelector('[name="status"]').checked ? 'completed' : 'active';

            if (scheduleData.german_board_applicants) scheduleData.german_board_applicants = scheduleData.german_board_applicants.split(',').map(s => s.trim());
            else scheduleData.german_board_applicants = [];

            const sanitizedData = sanitizeData(scheduleData);
            
            const { data: savedSchedule, error: scheduleError } = id 
                ? await supabaseClient.from('schedules').update(sanitizedData).eq('id', id).select().single()
                : await supabaseClient.from('schedules').insert([sanitizedData]).select().single();
            
            if (scheduleError) { console.error(scheduleError); Swal.fire('خطأ!', 'خطأ في حفظ الموعد.', 'error'); return; }

            // Only update enrollments if the course is not completed
            if (savedSchedule.status !== 'completed') {
                const courseId = savedSchedule.course_id;
                if (!courseId) {
                    Swal.fire('تم!', 'تم حفظ الموعد، ولكن لم يتم تحديد كورس لتحديث قائمة الطلاب.', 'info');
                    scheduleModal.hide(); fetchSchedules(); return;
                }

                const { data: currentEnrollmentsData } = await supabaseClient.from('trainee_enrollments').select('trainee_id').eq('course_id', courseId);
                const currentTraineeIds = new Set(currentEnrollmentsData.map(e => e.trainee_id));
                const newTraineeIds = new Set(scheduleSelectedTrainees.keys());

                const traineesToAdd = [...newTraineeIds].filter(tid => !currentTraineeIds.has(tid));
                const traineesToRemove = [...currentTraineeIds].filter(tid => !newTraineeIds.has(tid));

                if (traineesToRemove.length > 0) {
                    await supabaseClient.from('trainee_enrollments').delete().eq('course_id', courseId).in('trainee_id', traineesToRemove);
                }
                
                if (traineesToAdd.length > 0) {
                    const enrollmentsToInsert = traineesToAdd.map(traineeId => ({ course_id: courseId, trainee_id: traineeId }));
                    await supabaseClient.from('trainee_enrollments').insert(enrollmentsToInsert);
                }
            }

            Swal.fire('تم!', 'تم الحفظ بنجاح!', 'success');
            scheduleModal.hide();
            fetchSchedules();
            fetchTrainees();
        }
        
        function handleDeleteSchedule(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('schedules').delete().eq('id', id);
                if (error) Swal.fire('خطأ!', 'خطأ في الحذف.', 'error');
                else { Swal.fire('تم الحذف!', '', 'success'); fetchSchedules(); }
            }, `هل أنت متأكد من حذف موعد "${name}"؟`);
        }
        
        const attendanceModal = new bootstrap.Modal(document.getElementById('attendanceModal'));
        
        function getTodayDateString() {
            const todayDate = new Date();
            const year = todayDate.getFullYear();
            const month = String(todayDate.getMonth() + 1).padStart(2, '0');
            const day = String(todayDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function openAttendanceModal(scheduleId, courseName) {
            hideAllTooltips();
            const form = document.getElementById('attendanceForm');
            form.reset();
            form.querySelector('[name="schedule_id"]').value = scheduleId;
            document.getElementById('attendanceModalTitle').textContent = `تفقد كورس: ${courseName}`;
            
            const today = getTodayDateString();
            const dateInput = document.getElementById('attendance_date');
            dateInput.value = today;

            await loadAttendanceForDate(scheduleId, today);
            
            attendanceModal.show();
        }

        async function loadAttendanceForDate(scheduleId, date) {
            const studentListDiv = document.getElementById('attendance-student-list');
            studentListDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

            const { data: scheduleData } = await supabaseClient.from('schedules').select('courses(id)').eq('id', scheduleId).single();
            if (!scheduleData) { studentListDiv.innerHTML = 'خطأ: لم يتم العثور على الكورس.'; return; }
            
            const { data: enrollments } = await supabaseClient.from('trainee_enrollments').select('trainees(*)').eq('course_id', scheduleData.courses.id);
            if (!enrollments) { studentListDiv.innerHTML = 'خطأ في جلب الطلاب.'; return; }

            const { data: attendanceRecords } = await supabaseClient.from('attendance').select('*').eq('schedule_id', scheduleId).eq('attendance_date', date);
            
            if (enrollments.length === 0) {
                studentListDiv.innerHTML = '<div class="alert alert-info">لا يوجد طلاب مسجلين في هذا الكورس.</div>';
                return;
            }

            studentListDiv.innerHTML = enrollments.map(enrollment => {
                const trainee = enrollment.trainees;
                if (!trainee) return ''; // Skip if trainee data is missing
                const record = attendanceRecords ? attendanceRecords.find(r => r.trainee_id === trainee.id) : null;
                const status = record ? record.status : 'حاضر'; // Default to present
                return `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2" style="border-color: var(--border-color) !important;">
                    <span>${trainee.fullname}</span>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="attendance-${trainee.id}" id="present-${trainee.id}" value="حاضر" ${status === 'حاضر' ? 'checked' : ''}>
                        <label class="btn btn-outline-success btn-sm" for="present-${trainee.id}">حاضر</label>
                        <input type="radio" class="btn-check" name="attendance-${trainee.id}" id="absent-${trainee.id}" value="غائب" ${status === 'غائب' ? 'checked' : ''}>
                        <label class="btn btn-outline-danger btn-sm" for="absent-${trainee.id}">غائب</label>
                        <input type="radio" class="btn-check" name="attendance-${trainee.id}" id="late-${trainee.id}" value="متأخر" ${status === 'متأخر' ? 'checked' : ''}>
                        <label class="btn btn-outline-warning btn-sm" for="late-${trainee.id}">متأخر</label>
                    </div>
                </div>`;
            }).join('');
        }
        
        document.getElementById('attendance_date').addEventListener('change', (e) => {
            const scheduleId = document.getElementById('attendanceForm').querySelector('[name="schedule_id"]').value;
            loadAttendanceForDate(scheduleId, e.target.value);
        });

        async function handleAttendanceFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const schedule_id = formData.get('schedule_id');
            const attendance_date = formData.get('attendance_date');
            
            const records = [];
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('attendance-')) {
                    const trainee_id = key.split('-')[1];
                    records.push({ schedule_id, trainee_id, attendance_date, status: value });
                }
            }

            const { error } = await supabaseClient.from('attendance').upsert(records, { onConflict: 'schedule_id,trainee_id,attendance_date' });
            if (error) { console.error('Error saving attendance:', error); Swal.fire('خطأ!', 'خطأ في حفظ التفقد.', 'error'); } 
            else { Swal.fire('تم!', 'تم حفظ التفقد بنجاح!', 'success'); attendanceModal.hide(); }
        }
        
        const courseDetailModal = new bootstrap.Modal(document.getElementById('courseDetailModal'));
        async function openCourseDetailModal(courseId, courseName) {
            hideAllTooltips();
            document.getElementById('courseDetailModalTitle').textContent = `الطلاب المسجلون في: ${courseName}`;
            const body = document.getElementById('courseDetailModalBody');
            body.innerHTML = '<div class="loader"><div class="spinner-border text-primary" role="status"></div></div>';
            courseDetailModal.show();

            const { data, error } = await supabaseClient
                .from('trainee_enrollments')
                .select('trainees(fullname)')
                .eq('course_id', courseId);
            
            if (error) {
                body.innerHTML = '<div class="alert alert-danger">خطأ في جلب بيانات الطلاب.</div>';
                return;
            }

            if (data.length === 0) {
                body.innerHTML = '<div class="alert alert-info">لا يوجد طلاب مسجلون في هذا الكورس حالياً.</div>';
                return;
            }

            body.innerHTML = `
                <ul class="list-group list-group-flush">
                    ${data.map(enrollment => `<li class="list-group-item" style="background: transparent; color: var(--text-primary);">${enrollment.trainees.fullname}</li>`).join('')}
                </ul>
            `;
        }

        async function fetchSummaryData() {
            showLoader('summary-content');
            
            // Fetch all data in parallel
            const [
                { count: traineeCount },
                { data: courses },
                { data: enrollments }
            ] = await Promise.all([
                supabaseClient.from('trainees').select('*', { count: 'exact', head: true }),
                supabaseClient.from('courses').select('*').order('name'),
                supabaseClient.from('trainee_enrollments').select('course_id, courses(name)')
            ]);
            
            allCoursesCache = courses || [];

            // Calculate popular courses
            const courseCounts = {};
            if (enrollments) {
                enrollments.forEach(enrollment => {
                    if (enrollment.courses) {
                        const courseId = enrollment.course_id;
                        const courseName = enrollment.courses.name;
                        if (!courseCounts[courseId]) {
                            courseCounts[courseId] = { name: courseName, count: 0 };
                        }
                        courseCounts[courseId].count++;
                    }
                });
            }
            const popularCourses = Object.entries(courseCounts)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5); // Get top 5

            // MODIFIED for new Summary Card layout
            document.getElementById('summary-content').innerHTML = `
                <div class="row">
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="summary-card text-center h-100">
                             <div class="icon"><i class="fas fa-users"></i></div>
                             <h5>إجمالي الطلاب</h5>
                             <p class="value m-0">${traineeCount || 0}</p>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-6 mb-4">
                        <div class="summary-card h-100">
                            <h5 class="text-center mb-3">الكورسات الأكثر طلباً</h5>
                            <div id="popular-courses-list">
                                ${popularCourses.length > 0 ? `
                                    <ul class="list-group list-group-flush">
                                        ${popularCourses.map(course => `
                                            <li class="list-group-item d-flex justify-content-between align-items-center clickable" style="background: transparent; color: var(--text-primary); border-color: var(--border-color);" onclick="openCourseDetailModal('${course.id}', '${course.name}')">
                                                ${course.name}
                                                <span class="badge rounded-pill" style="background-color: var(--accent-primary);">${course.count}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : '<p class="text-center text-secondary">لا توجد بيانات تسجيل لعرضها.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="summary-card">
                            <h5 class="text-center">إدارة الكورسات</h5>
                            <form id="addCourseForm" class="d-flex mt-3 mb-3">
                                <input type="text" name="name" class="form-control me-2" placeholder="اسم الكورس الجديد" required>
                                <button type="submit" class="btn btn-success flex-shrink-0">إضافة</button>
                            </form>
                            <ul id="coursesList" class="list-group list-group-flush">
                                ${courses && courses.length > 0 ? courses.map(c => `<li class="list-group-item d-flex justify-content-between align-items-center" style="background: transparent; color: var(--text-primary); border-color: var(--border-color);">${c.name}<button class="btn btn-sm btn-outline-danger" onclick="handleDeleteCourse('${c.id}', '${c.name}')"><i class="fas fa-trash"></i></button></li>`).join('') : '<li class="list-group-item" style="background: transparent; color: var(--text-secondary);">لا توجد كورسات.</li>'}
                            </ul>
                        </div>
                    </div>
                </div>`;
            document.getElementById('addCourseForm').addEventListener('submit', handleAddCourse);
        }

        async function handleAddCourse(event) {
            event.preventDefault();
            const form = event.target;
            const courseName = new FormData(form).get('name');
            const { error } = await supabaseClient.from('courses').insert([{ name: courseName }]);
            if (error) Swal.fire('خطأ!', `خطأ: ${error.message}`, 'error');
            else { 
                Swal.fire('تم!', 'تمت الإضافة!', 'success');
                form.reset(); 
                fetchSummaryData(); 
            }
        }
        
        function handleDeleteCourse(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('courses').delete().eq('id', id);
                if (error) Swal.fire('خطأ!', 'خطأ في الحذف، قد يكون الكورس مرتبطاً بجدول.', 'error');
                else { 
                    Swal.fire('تم الحذف!', '', 'success');
                    fetchSummaryData(); 
                }
            }, `هل أنت متأكد من حذف كورس "${name}"؟`);
        }

        async function cacheAllTrainees() {
            const { data, error } = await supabaseClient.from('trainees').select('id, fullname');
            if (error) console.error("Could not cache trainees", error);
            else allTraineesCache = data || [];
        }

        async function cacheAllTrainers() {
            const { data, error } = await supabaseClient.from('trainers').select('id, fullname');
            if (error) console.error("Could not cache trainers", error);
            else allTrainersCache = data || [];
        }

        function renderScheduleTraineeSearchResults(searchTerm = '') {
            const resultsContainer = document.getElementById('schedule-trainee-search-results');
            if(!searchTerm) {
                resultsContainer.classList.add('d-none');
                return;
            }
            const availableTrainees = allTraineesCache.filter(trainee => !scheduleSelectedTrainees.has(trainee.id));
            const filtered = availableTrainees.filter(t => t.fullname.toLowerCase().includes(searchTerm.toLowerCase()));
            
            if(filtered.length > 0) {
                resultsContainer.innerHTML = `<ul class="list-group">${filtered.map(t => `<li class="list-group-item" onclick="selectTraineeForSchedule('${t.id}', '${t.fullname}')">${t.fullname}</li>`).join('')}</ul>`;
                resultsContainer.classList.remove('d-none');
            } else {
                resultsContainer.classList.add('d-none');
            }
        }

        function selectTraineeForSchedule(id, name) {
            scheduleSelectedTrainees.set(id, name);
            document.getElementById('schedule-trainee-search-input').value = '';
            document.getElementById('schedule-trainee-search-results').classList.add('d-none');
            renderScheduleSelectedTrainees();
        }

        function removeTraineeFromSchedule(id) {
            scheduleSelectedTrainees.delete(id);
            renderScheduleSelectedTrainees();
        }

        function renderScheduleSelectedTrainees() {
            const listContainer = document.getElementById('schedule-selected-trainees-list');
            if (scheduleSelectedTrainees.size === 0) {
                listContainer.innerHTML = '<p class="text-secondary small m-0">لم يتم اختيار طلاب بعد. استخدم البحث أعلاه للإضافة.</p>';
                return;
            }
            listContainer.innerHTML = '';
            for (const [id, name] of scheduleSelectedTrainees.entries()) {
                listContainer.innerHTML += `<div class="selected-tag" data-id="${id}">${name}<button type="button" onclick="removeTraineeFromSchedule('${id}')">&times;</button></div>`;
            }
        }
        
        function renderScheduleCourseSearchResults(searchTerm) {
            const resultsContainer = document.getElementById('schedule-course-search-results');
            if(!searchTerm) {
                resultsContainer.classList.add('d-none');
                return;
            }
            const filtered = allCoursesCache.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            if(filtered.length > 0) {
                resultsContainer.innerHTML = `<ul class="list-group">${filtered.map(item => `<li class="list-group-item" onclick="selectCourseForSchedule('${item.id}', '${item.name}')">${item.name}</li>`).join('')}</ul>`;
                resultsContainer.classList.remove('d-none');
            } else {
                resultsContainer.classList.add('d-none');
            }
        }

        function selectCourseForSchedule(id, name) {
            document.querySelector('#scheduleForm [name="course_id"]').value = id;
            document.getElementById('selected-schedule-course-display').innerHTML = `<span class="badge bg-primary">${name}</span>`;
            document.getElementById('schedule-course-search-input').value = '';
            document.getElementById('schedule-course-search-results').classList.add('d-none');
            
            const courseId = id;
            scheduleSelectedTrainees.clear(); 
            if (courseId) {
                supabaseClient.from('trainee_enrollments').select('trainees(id, fullname)').eq('course_id', courseId)
                .then(({ data: enrollments, error }) => {
                    if (error) console.error("Error fetching enrollments for selected course", error);
                    else if (enrollments) {
                        enrollments.forEach(e => {
                            if (e.trainees) scheduleSelectedTrainees.set(e.trainees.id, e.trainees.fullname);
                        });
                    }
                    renderScheduleSelectedTrainees();
                });
            } else {
                renderScheduleSelectedTrainees();
            }
        }

        function renderScheduleTrainerSearchResults(searchTerm) {
            const resultsContainer = document.getElementById('schedule-trainer-search-results');
            if(!searchTerm) {
                resultsContainer.classList.add('d-none');
                return;
            }
            const filtered = allTrainersCache.filter(item => item.fullname.toLowerCase().includes(searchTerm.toLowerCase()));
            
            if(filtered.length > 0) {
                resultsContainer.innerHTML = `<ul class="list-group">${filtered.map(item => `<li class="list-group-item" onclick="selectTrainerForSchedule('${item.id}', '${item.fullname}')">${item.fullname}</li>`).join('')}</ul>`;
                resultsContainer.classList.remove('d-none');
            } else {
                resultsContainer.classList.add('d-none');
            }
        }

        function selectTrainerForSchedule(id, name) {
            document.querySelector('#scheduleForm [name="trainer_id"]').value = id;
            document.getElementById('selected-schedule-trainer-display').innerHTML = `<span class="badge bg-primary">${name}</span>`;
            document.getElementById('schedule-trainer-search-input').value = '';
            document.getElementById('schedule-trainer-search-results').classList.add('d-none');
        }

        // --- CALENDAR LOGIC ---
        const appointmentModal = new bootstrap.Modal(document.getElementById('appointmentModal'));

        async function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const monthName = calendarDate.toLocaleString('ar-EG', { month: 'long' });
            document.getElementById('month-year-display').textContent = `${monthName} ${year}`;

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const dayHeaders = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            dayHeaders.forEach(day => {
                grid.innerHTML += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="calendar-day not-in-month"></div>`;
            }

            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('today');
                }
                
                const monthStr = String(month + 1).padStart(2, '0');
                const dayStr = String(i).padStart(2, '0');
                const dateString = `${year}-${monthStr}-${dayStr}`;

                dayCell.dataset.date = dateString;
                dayCell.innerHTML = `<span class="day-number">${i}</span><div class="events-container"></div>`;
                dayCell.addEventListener('click', () => openAppointmentModal(dateString));
                grid.appendChild(dayCell);
            }
            
            await fetchAndDisplayCalendarEvents(year, month);
        }

        async function fetchAndDisplayCalendarEvents(year, month) {
            const monthStr = String(month + 1).padStart(2, '0');
            const lastDay = new Date(year, month + 1, 0).getDate();
            const startDate = `${year}-${monthStr}-01`;
            const endDate = `${year}-${monthStr}-${lastDay}`;

            const { data: schedules, error: scheduleError } = await supabaseClient
                .from('schedules')
                .select('start_date, end_date, courses(name)')
                .gte('start_date', startDate)
                .lte('start_date', endDate);

            const { data: appointments, error: appointmentError } = await supabaseClient
                .from('appointments')
                .select('title, appointment_date')
                .gte('appointment_date', startDate)
                .lte('appointment_date', endDate);
            
            if (scheduleError) console.error("Error fetching schedules for calendar", scheduleError);
            if (appointmentError) console.error("Error fetching appointments for calendar", appointmentError);

            if (schedules) {
                schedules.forEach(event => {
                    const dayCell = document.querySelector(`.calendar-day[data-date="${event.start_date}"]`);
                    if (dayCell) {
                        dayCell.querySelector('.events-container').innerHTML += `<div class="event-dot course">${event.courses.name}</div>`;
                    }
                });
            }

            if (appointments) {
                appointments.forEach(event => {
                    const dayCell = document.querySelector(`.calendar-day[data-date="${event.appointment_date}"]`);
                    if (dayCell) {
                        dayCell.querySelector('.events-container').innerHTML += `<div class="event-dot appointment">${event.title}</div>`;
                    }
                });
            }
        }

        async function openAppointmentModal(dateString) {
            hideAllTooltips();
            const form = document.getElementById('appointmentForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            form.querySelector('[name="appointment_date"]').value = dateString;
            document.getElementById('appointment-form-section-title').textContent = 'إضافة موعد جديد';
            document.getElementById('appointmentModalTitle').textContent = `مواعيد يوم ${dateString}`;
            
            const listContainer = document.getElementById('day-appointments-list');
            listContainer.innerHTML = 'جاري تحميل المواعيد...';
            
            const { data: appointments, error } = await supabaseClient
                .from('appointments')
                .select('*')
                .eq('appointment_date', dateString)
                .order('created_at');
                
            if (error) {
                listContainer.innerHTML = '<div class="alert alert-danger">خطأ في جلب المواعيد.</div>';
            } else if (appointments.length === 0) {
                listContainer.innerHTML = '<p class="text-secondary">لا توجد مواعيد خاصة لهذا اليوم.</p>';
            } else {
                listContainer.innerHTML = `
                    <h6 class="form-section-title">المواعيد المسجلة:</h6>
                    <ul class="list-group list-group-flush">
                        ${appointments.map(apt => `
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0" style="background: transparent; color: var(--text-primary); border-color: var(--border-color) !important;">
                                <div>
                                    <strong>${apt.title}</strong>
                                    <p class="mb-0 small text-secondary">${apt.description || ''}</p>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="editAppointment('${apt.id}')"><i class="fas fa-edit"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="handleDeleteAppointment('${apt.id}', '${dateString}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </li>
                        `).join('')}
                    </ul>`;
            }
            
            appointmentModal.show();
        }

        async function editAppointment(id) {
            const { data, error } = await supabaseClient.from('appointments').select('*').eq('id', id).single();
            if (error || !data) {
                Swal.fire('خطأ!', 'لم يتم العثور على الموعد.', 'error');
                return;
            }
            
            const form = document.getElementById('appointmentForm');
            form.querySelector('[name="id"]').value = data.id;
            form.querySelector('[name="title"]').value = data.title;
            form.querySelector('[name="appointment_date"]').value = data.appointment_date;
            form.querySelector('[name="description"]').value = data.description;
            
            document.getElementById('appointment-form-section-title').textContent = 'تعديل الموعد';
        }

        function handleDeleteAppointment(id, dateString) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('appointments').delete().eq('id', id);
                if (error) {
                    Swal.fire('خطأ!', 'خطأ في حذف الموعد.', 'error');
                } else {
                    Swal.fire('تم!', 'تم الحذف بنجاح.', 'success');
                    openAppointmentModal(dateString); 
                    renderCalendar();
                }
            }, 'هل أنت متأكد من حذف هذا الموعد؟');
        }

        async function handleAppointmentFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let appointmentData = Object.fromEntries(formData.entries());
            const id = appointmentData.id;
            const dateString = appointmentData.appointment_date;
            
            delete appointmentData.id;

            const sanitizedData = sanitizeData(appointmentData);

            const { error } = id
                ? await supabaseClient.from('appointments').update(sanitizedData).eq('id', id)
                : await supabaseClient.from('appointments').insert([sanitizedData]);

            if (error) {
                console.error('Error saving appointment:', error);
                Swal.fire('خطأ!', 'خطأ في حفظ الموعد.', 'error');
            } else {
                Swal.fire('تم!', 'تم حفظ الموعد بنجاح!', 'success');
                form.reset();
                form.querySelector('[name="id"]').value = '';
                document.getElementById('appointment-form-section-title').textContent = 'إضافة موعد جديد';
                openAppointmentModal(dateString);
                renderCalendar();
            }
        }

        // --- INVENTORY LOGIC ---
        const inventoryTransactionModal = new bootstrap.Modal(document.getElementById('inventoryTransactionModal'));
        const inventoryDetailModal = new bootstrap.Modal(document.getElementById('inventoryDetailModal'));

        async function fetchInventoryData(searchTerm = '') {
            showLoader('inventory-results');
            
            let itemsQuery = supabaseClient.from('inventory_items').select('id, name');
            if(searchTerm) {
                itemsQuery = itemsQuery.ilike('name', `%${searchTerm}%`);
            }
            const { data: items, error: itemsError } = await itemsQuery.order('name');

            if (itemsError) {
                console.error("Error fetching inventory items", itemsError);
                return;
            }

            const { data: transactions, error: transError } = await supabaseClient.from('inventory_transactions').select('*');
            if (transError) {
                console.error("Error fetching inventory transactions", transError);
                return;
            }

            const inventoryData = items.map(item => {
                const itemTransactions = transactions.filter(t => t.item_id === item.id);
                const totalIn = itemTransactions.filter(t => t.transaction_type === 'in').reduce((sum, t) => sum + t.quantity, 0);
                const totalOut = itemTransactions.filter(t => t.transaction_type === 'out').reduce((sum, t) => sum + t.quantity, 0);
                const balance = totalIn - totalOut;
                return { ...item, totalIn, totalOut, balance };
            });

            displayInventory(inventoryData);
        }

        function getBalanceClass(balance) {
            if (balance <= 0) return 'balance-danger';
            if (balance <= 10) return 'balance-low';
            return 'balance-ok';
        }

        function displayInventory(inventoryData) {
            const container = document.getElementById('inventory-results');
            if (inventoryData.length === 0) {
                container.innerHTML = '<div class="alert alert-info">لا توجد أصناف في المخزون. أضف صنفاً جديداً للبدء.</div>';
                return;
            }

            container.innerHTML = `
                <table class="table table-hover align-middle inventory-table">
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>إجمالي الداخل</th>
                            <th>إجمالي الخارج</th>
                            <th>الرصيد الحالي</th>
                            <th class="actions-cell text-start">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${inventoryData.map(item => `
                            <tr id="item-row-${item.id}">
                                <td class="item-name-cell">
                                    <span id="item-name-${item.id}">${item.name}</span>
                                    <input type="text" class="form-control d-none" id="item-input-${item.id}" value="${item.name}">
                                </td>
                                <td>${item.totalIn}</td>
                                <td>${item.totalOut}</td>
                                <td class="fw-bold ${getBalanceClass(item.balance)}">${item.balance}</td>
                                <td class="actions-cell text-start" onclick="event.stopPropagation();">
                                    <div id="actions-view-${item.id}" class="btn-group">
                                        <button class="btn btn-sm" onclick="openInventoryDetailModal('${item.id}', '${item.name}')" title="عرض التفاصيل" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-list-ul text-info"></i></button>
                                        <button class="btn btn-sm" onclick="toggleItemEditMode('${item.id}', true)" title="تعديل الاسم" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-edit text-primary"></i></button>
                                        <button class="btn btn-sm" onclick="handleDeleteInventoryItem('${item.id}', '${item.name}')" title="حذف الصنف" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-trash text-danger"></i></button>
                                    </div>
                                    <div id="actions-edit-${item.id}" class="d-none btn-group">
                                        <button class="btn btn-sm" onclick="handleUpdateInventoryItem('${item.id}')" title="حفظ"><i class="fas fa-check text-success"></i></button>
                                        <button class="btn btn-sm" onclick="toggleItemEditMode('${item.id}', false)" title="إلغاء"><i class="fas fa-times text-secondary"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            initializeTooltips();
        }
        
        function toggleItemEditMode(itemId, isEditing) {
            hideAllTooltips();
            document.getElementById(`item-name-${itemId}`).classList.toggle('d-none', isEditing);
            document.getElementById(`item-input-${itemId}`).classList.toggle('d-none', !isEditing);
            document.getElementById(`actions-view-${itemId}`).classList.toggle('d-none', isEditing);
            document.getElementById(`actions-edit-${itemId}`).classList.toggle('d-none', !isEditing);
            if (isEditing) {
                document.getElementById(`item-input-${itemId}`).focus();
            }
        }

        async function handleUpdateInventoryItem(itemId) {
            const newName = document.getElementById(`item-input-${itemId}`).value.trim();
            if (!newName) {
                Swal.fire('تنبيه!', 'اسم الصنف لا يمكن أن يكون فارغاً.', 'warning');
                return;
            }
            const { error } = await supabaseClient.from('inventory_items').update({ name: newName }).eq('id', itemId);
            if (error) {
                console.error("Error updating item:", error);
                Swal.fire('خطأ!', 'خطأ في تحديث الصنف.', 'error');
            } else {
                fetchInventoryData(); // Refresh the table
            }
        }

        function handleDeleteInventoryItem(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('inventory_items').delete().eq('id', id);
                if (error) {
                    Swal.fire('خطأ!', 'خطأ في حذف الصنف.', 'error');
                } else {
                    Swal.fire('تم!', 'تم حذف الصنف وجميع حركاته بنجاح.', 'success');
                    fetchInventoryData();
                }
            }, `هل أنت متأكد من حذف صنف "${name}"؟ سيتم حذف جميع الحركات المرتبطة به أيضاً.`);
        }

        async function openInventoryItemModal() {
            hideAllTooltips();
            const { value: itemName } = await Swal.fire({
                title: 'إضافة صنف جديد',
                input: 'text',
                inputLabel: 'اسم الصنف',
                inputPlaceholder: 'أدخل اسم الصنف هنا...',
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                customClass: {
                    popup: 'bg-dark',
                    title: 'text-white',
                    input: 'form-control',
                },
                inputValidator: (value) => {
                    if (!value) {
                        return 'يجب إدخال اسم الصنف!'
                    }
                }
            });

            if (itemName) {
                const { error } = await supabaseClient.from('inventory_items').insert([{ name: itemName }]);
                if (error) {
                    console.error("Error adding inventory item:", error);
                    Swal.fire('خطأ!', 'حدث خطأ أثناء إضافة الصنف. قد يكون الاسم مكرراً.', 'error');
                } else {
                    Swal.fire('تم!', 'تمت إضافة الصنف بنجاح.', 'success');
                    await cacheInventoryItems();
                    fetchInventoryData();
                }
            }
        }
        
        async function cacheInventoryItems() {
            const { data, error } = await supabaseClient.from('inventory_items').select('id, name').order('name');
            if (error) console.error("Error caching inventory items", error);
            else allInventoryItemsCache = data || [];
        }

        async function openTransactionModal(transactionId = null) {
            hideAllTooltips();
            const form = document.getElementById('inventoryTransactionForm');
            form.reset();
            const modalTitle = document.getElementById('inventoryTransactionModalTitle');
            
            form.querySelector('[name="item_id"]').value = '';
            document.getElementById('selected-inventory-item-display').innerHTML = '';
            document.getElementById('inventory-item-search-input').value = '';

            if (allInventoryItemsCache.length === 0) {
                await cacheInventoryItems();
            }

            if (transactionId) {
                modalTitle.textContent = 'تعديل حركة مخزون';
                const { data, error } = await supabaseClient.from('inventory_transactions').select('*, inventory_items(name)').eq('id', transactionId).single();
                if (error || !data) {
                    Swal.fire('خطأ!', 'لم يتم العثور على الحركة.', 'error');
                    return;
                }
                form.querySelector('[name="id"]').value = data.id;
                selectInventoryItem(data.item_id, data.inventory_items.name);
                form.querySelector('[name="transaction_type"]').value = data.transaction_type;
                form.querySelector('[name="quantity"]').value = data.quantity;
                form.querySelector('[name="transaction_date"]').value = data.transaction_date;
                form.querySelector('[name="description"]').value = data.description;
            } else {
                modalTitle.textContent = 'إضافة حركة مخزون';
                form.querySelector('[name="id"]').value = '';
                form.querySelector('[name="transaction_date"]').value = getTodayDateString();
            }
            
            if(detailModalInstance) detailModalInstance.hide();
            setTimeout(() => transactionModalInstance.show(), 200);
        }
        
        async function openInventoryDetailModal(itemId, itemName) {
            hideAllTooltips();
            lastOpenedDetail = { itemId, itemName };
            document.getElementById('inventoryDetailModalTitle').textContent = `تفاصيل حركات: ${itemName}`;
            const body = document.getElementById('inventoryDetailModalBody');
            body.innerHTML = '<div class="loader"><div class="spinner-border text-primary" role="status"></div></div>';
            inventoryDetailModal.show();

            const { data, error } = await supabaseClient
                .from('inventory_transactions')
                .select('*')
                .eq('item_id', itemId)
                .order('transaction_date', { ascending: false });

            if (error) {
                body.innerHTML = '<div class="alert alert-danger">خطأ في جلب الحركات.</div>';
                return;
            }

            if (data.length === 0) {
                body.innerHTML = '<div class="alert alert-info">لا توجد حركات مسجلة لهذا الصنف.</div>';
                return;
            }

            body.innerHTML = `
                <table class="table table-hover align-middle inventory-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>الكمية</th>
                            <th>البيان</th>
                            <th class="text-end">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(t => `
                            <tr>
                                <td>${t.transaction_date}</td>
                                <td>${t.transaction_type === 'in' ? '<span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">داخل</span>' : '<span class="badge bg-danger-subtle text-danger-emphasis border border-danger-subtle">خارج</span>'}</td>
                                <td class="fw-bold">${t.quantity}</td>
                                <td class="text-secondary">${t.description || '-'}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-light" onclick="openTransactionModal('${t.id}')" title="تعديل"><i class="fas fa-edit text-primary"></i></button>
                                    <button class="btn btn-sm btn-light" onclick="handleDeleteInventoryTransaction('${t.id}', '${itemId}', '${itemName}')" title="حذف"><i class="fas fa-trash text-danger"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            initializeTooltips();
        }

        function handleDeleteInventoryTransaction(transactionId, itemId, itemName) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('inventory_transactions').delete().eq('id', transactionId);
                if (error) {
                    Swal.fire('خطأ!', 'خطأ في حذف الحركة.', 'error');
                } else {
                    Swal.fire('تم!', 'تم حذف الحركة بنجاح.', 'success');
                    openInventoryDetailModal(itemId, itemName); // Refresh detail modal
                    fetchInventoryData(); // Refresh main inventory table
                }
            }, 'هل أنت متأكد من حذف هذه الحركة؟ هذا الإجراء لا يمكن التراجع عنه.');
        }

        async function handleInventoryTransactionSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const transactionData = Object.fromEntries(formData.entries());
            const id = transactionData.id;

            if (!transactionData.item_id) {
                Swal.fire('تنبيه!', 'الرجاء اختيار صنف.', 'warning');
                return;
            }

            const dataToSubmit = { ...transactionData };
            delete dataToSubmit.id;
            
            const { error } = id
                ? await supabaseClient.from('inventory_transactions').update(dataToSubmit).eq('id', id)
                : await supabaseClient.from('inventory_transactions').insert([dataToSubmit]);

            if (error) {
                console.error("Error saving transaction:", error);
                Swal.fire('خطأ!', 'خطأ في حفظ الحركة.', 'error');
            } else {
                Swal.fire('تم!', 'تم حفظ الحركة بنجاح.', 'success');
                document.getElementById('inventoryTransactionModal')._transactionWasSaved = true;
                inventoryTransactionModal.hide();
                fetchInventoryData();
            }
        }
        
        function renderInventoryItemSearchResults(searchTerm) {
            const resultsContainer = document.getElementById('inventory-item-search-results');
            if(!searchTerm) {
                resultsContainer.classList.add('d-none');
                return;
            }
            const filtered = allInventoryItemsCache.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            if(filtered.length > 0) {
                resultsContainer.innerHTML = `<ul class="list-group">${filtered.map(item => `<li class="list-group-item" onclick="selectInventoryItem('${item.id}', '${item.name}')">${item.name}</li>`).join('')}</ul>`;
                resultsContainer.classList.remove('d-none');
            } else {
                resultsContainer.classList.add('d-none');
            }
        }

        function selectInventoryItem(id, name) {
            document.querySelector('#inventoryTransactionForm [name="item_id"]').value = id;
            document.getElementById('selected-inventory-item-display').innerHTML = `<span class="badge bg-primary">${name}</span>`;
            document.getElementById('inventory-item-search-input').value = '';
            document.getElementById('inventory-item-search-results').classList.add('d-none');
        }


        // --- APP INITIALIZATION ---
        function initializeApp() {
            // Initialize Modals
            transactionModalInstance = new bootstrap.Modal(document.getElementById('inventoryTransactionModal'));
            detailModalInstance = new bootstrap.Modal(document.getElementById('inventoryDetailModal'));

            // Setup new navigation
            setupSidebarNavigation();

            // Fetch initial data
            fetchSummaryData();
            fetchTrainees();
            fetchTrainers();
            fetchSchedules();
            cacheAllTrainees();
            cacheAllTrainers();
            renderCalendar();
            fetchInventoryData();
            cacheInventoryItems();

            // Setup event listeners
            document.getElementById('trainee-search-btn').addEventListener('click', () => fetchTrainees(document.getElementById('trainee-search-input').value));
            document.getElementById('trainer-search-btn').addEventListener('click', () => fetchTrainers(document.getElementById('trainer-search-input').value));
            document.getElementById('schedule-search-btn').addEventListener('click', () => fetchSchedules(document.getElementById('schedule-search-input').value));
            document.getElementById('inventory-search-btn').addEventListener('click', () => fetchInventoryData(document.getElementById('inventory-search-input').value));
            
            document.getElementById('addTrainerBtn').addEventListener('click', () => openTrainerModal());
            document.getElementById('addTraineeBtn').addEventListener('click', () => openTraineeModal());
            document.getElementById('addScheduleBtn').addEventListener('click', () => openScheduleModal());
            document.getElementById('addInventoryItemBtn').addEventListener('click', openInventoryItemModal);
            document.getElementById('addInventoryTransactionBtn').addEventListener('click', () => openTransactionModal());

            document.getElementById('traineeForm').addEventListener('submit', handleTraineeFormSubmit);
            document.getElementById('trainerForm').addEventListener('submit', handleTrainerFormSubmit);
            document.getElementById('scheduleForm').addEventListener('submit', handleScheduleFormSubmit);
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceFormSubmit);
            document.getElementById('appointmentForm').addEventListener('submit', handleAppointmentFormSubmit);
            document.getElementById('inventoryTransactionForm').addEventListener('submit', handleInventoryTransactionSubmit);
            
            document.getElementById('course-search-input').addEventListener('keyup', (e) => renderCourseSearchResults(e.target.value));
            document.getElementById('schedule-trainee-search-input').addEventListener('keyup', (e) => renderScheduleTraineeSearchResults(e.target.value));
            document.getElementById('inventory-item-search-input').addEventListener('keyup', (e) => renderInventoryItemSearchResults(e.target.value));
            document.getElementById('schedule-course-search-input').addEventListener('keyup', (e) => renderScheduleCourseSearchResults(e.target.value));
            document.getElementById('schedule-trainer-search-input').addEventListener('keyup', (e) => renderScheduleTrainerSearchResults(e.target.value));
            
            document.getElementById('courseStatus').addEventListener('change', function() {
                toggleScheduleFormLock(this.checked);
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Modal chaining logic
            const transactionModalEl = document.getElementById('inventoryTransactionModal');
            transactionModalEl.addEventListener('hidden.bs.modal', () => {
                if (!transactionModalEl._transactionWasSaved && lastOpenedDetail.itemId) {
                    detailModalInstance.show();
                }
                transactionModalEl._transactionWasSaved = false; // Reset flag
            });
            
            // Initialize SweetAlert2 to use dark theme
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                },
                background: 'var(--bg-tertiary)',
                color: 'var(--text-primary)'
            });
            // Example of how to use the new toast: Toast.fire({ icon: 'success', title: 'Signed in successfully' })
        }
        
        function initializeTooltips() {
            const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            existingTooltips.forEach(el => {
                const tooltip = bootstrap.Tooltip.getInstance(el);
                if (tooltip) {
                    tooltip.dispose();
                }
            });
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        }

        document.addEventListener('DOMContentLoaded', checkUser);

    </script>
</body>
</html>
